<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title> Comet </title><meta charset="utf8"/><link rel="stylesheet" href="file:///home/balat/ocsigen/ocsigen.github.io/css/style.css"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/themes/prism.min.css"/><script src="/client.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-core.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-ocaml.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-clike.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-reason.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.9.0/components/prism-javascript.min.js"></script></head><body><h1> Comet </h1><p><em>Available from Ocsigen server version 1.90</em>
</p><p>This extension provides an easy way for the server to send messages to the connected clients. It can be used as such or wrapped in a high-level module. Such a wrapping is provided in Eliom. The whole implementation is in the <span class="teletype">extensions/comet.ml</span> file, the corresponding interface is in the associated mli file.
</p><h2>User interface</h2><p>The user interface for the extension is quite simple. It is divided into two distinct modules, namely <span class="teletype">Channels</span> and <span class="teletype">Security</span>. The former allow channel creation and tampering while the latter gives a few functions to interrupt normal execution flow. The interfaces of both modules are pretty straight forward. Documentation is provided for each function in the mli file.
</p><p>The <span class="teletype">Channels</span> module important functions are: <span class="teletype">create</span> for channel creation, <span class="teletype">write</span> to actually send a message and <span class="teletype">get_id</span> to get a channel identifier. Detailed description is available in the mli file.
</p><p>The <span class="teletype">Security</span> module is accessible from Ocsigen's command pipe. The different commands are<span class="teletype">deactivate</span>, <span class="teletype">activate</span> and <span class="teletype">set_timeout</span>, the meaning of each of them along with their arguments are given in the mli file.
</p><h2>Specifications and client implementation</h2><p>If not used with the Eliom high-level wrap, it is up to the developer to create a compatible client code. This task requires one to know the protocol used by the extension.
</p><p>It is the client's responsibility to open a connection indicating the channels it want to be registered to. This is acheived by making an Xml Http Request (XHR) with the following characteristics: the content-type header field must read <span class="teletype">application/x-ocsigen-comet</span>, the <span class="teletype">registration</span> POST parameter must be included with a list of channel as value. The said list should be made of channel identifiers separated by newline (<span class="teletype">\n</span>) character and encoded according to the escape Javascript primitive. Following is an example of list for registration:
</p><pre>randomstringblahblahtotofoocoucoubardfhkqjsdkjdfgqf
nicely%20encoded%20channel%20identifier
foooobaarfoofoo
</pre><p>When the server receives an XHR with a comet specific content-type it decodes the registration list, and waits for one of them to be written upon. Then it either times out sending an empty answer or answers with a list of values written on channels. The said list is newline separated and contains channel identifier-value tuples. The reserved value <span class="teletype">&quot;ENDED_CHANNEL&quot;</span> marks channels that no longer exists on the server (their identifier is no longer relevant). An example of answer the server can make to the example client XHR is:
</p><pre>randomstringblahblahtotofoocoucoubardfhkqjsdkjdfgqf:ENDED_CHANNEL
nicely%20encoded%20channel%20identifier:42%2043%2044
</pre><p>In this example, the first channel identifier is no longer associated to any channel on the server, the second channel receives the encoded string value <span class="teletype">&quot;42 43 44&quot;</span> and the third channel hasn't been written upon.
</p></body></html>
